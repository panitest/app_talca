<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<title>Talca</title>
<link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="santander.css">
  <link href="querys.css" rel="stylesheet" >
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="font-awesome-4.6.3/css/font-awesome.css" type="text/css" charset="utf-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="phonegap.js"></script>
<script type="text/javascript" src="js/panino.js"></script>
<script type="text/javascript" src="js/comunes.js"></script>
<script type="text/javascript" src="js/paninoAJAX.js"></script>
<script>
function getPage(p,callback){
		request(
			p,
			function(r){
				scrollTo(0,0);
				_('appcontainer').innerHTML=r;
				if(typeof callback=='function'){
					callback();
				}
				if(_('navfixed')){
					document.body.style.paddingTop=_('navfixed').offsetHeight+'px';
				}else{
					document.body.style.paddingTop=0;
				}
			},
			{}
		);
}
var pictureSource;   // picture source
var destinationType; // sets the format of returned value 
document.addEventListener("deviceready",onDeviceReady,false);
function onDeviceReady() {
	pictureSource=navigator.camera.PictureSourceType;
	destinationType=navigator.camera.DestinationType;
	setTimeout(function() {
        navigator.splashscreen.hide();
    }, 2000);
}
function capturePhotoWithFile() {
	
	
	navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 100, destinationType: Camera.DestinationType.FILE_URI,
  encodingType: Camera.EncodingType.JPEG,
  targetWidth: 1000,
  targetHeight: 1000,
  saveToPhotoAlbum: false });
}
function onFail(message){
		//alert('Failed because: ' + message);
		getPage('home.html');
}
	
function onPhotoURISuccess(imageURI){
	getPage('procesando.html');
	goToSever(imageURI,640,640,function(){/*callback*/});
}
function win(r){
	/*
if(r.response.indexOf('.jpg')==-1){
	getPage('home.html');
	alert(r.response);
	return;
}
	*/	
	//alert(r.response);
	/*var rtaws='[\"Q Search\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\\u2018 \\u2018 \\u2018 \\u2018 DmMod\\ufb02l-d -\",\"wk Thduy, 1:59 PM\",\"!O160929_13_34_10.Jpg Today, 1:33 PM\",\"\",\"I\\u201c Tnday, 11:19 AM\",\"\",\"Ink Argentlna 01611100 Today, 11.16 AM\",\".INVOICE_DODS_FAOOUDSZ461pdl Today. 6:34 AM\",\"\",\")r [1L7Jn Yasmnmv. 4:04 PM\",\"\",\"\\\"1 a G talca frontbmp Open With Preview m 3\",\"\",\"589686 01 12053290 0 6\",\"ALVARO J FLORES VENEGAS\",\"\",\"v2 070 9294 ESTUDIANTE\",\"INGENIERIA INDUSTRIAL CIVIL\",\"\",\"m W, ******* , Mmzmimwm\",\"(13.90\\\" AM] 5 2016 9 16 AM\",\"dams X\\u2018sx\",\"\",\"PG\",\"\",\"yummom: 4 Um-nvhnul; m .. w H , rm:\",\"\",\"\",\"\",\"\",\"\"]';
	*/
	var rtaws=r.response;
	var v=JSON.parse(rtaws);
	if(v.length<3){
		getPage('home.html');
		alert('Por favor escanee la tarjeta nuevamente');
		return;
	}
	parseRta(v);
	
}
function fail(r){
	    getPage('home.html');
		alert('La imagen no pudo subirse');
}
function goToSever(imageURI,maxWidth,maxHeight,callback) {
			var options = new FileUploadOptions();
            options.fileKey="foto";
            options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
            options.mimeType="image/jpeg";
 
            var params = new Object();
            params.proceso = "crop";
          
            options.params = params;
            options.chunkedMode = false;
 
            var ft = new FileTransfer();
			ns.callback=callback;
            //ft.upload(imageURI, encodeURI('http://servidordeapps.com/proceso3.php?'+(+new Date())), win, fail, options);
			ft.upload(imageURI, encodeURI('http://ocr.acrons.net/proceso3.php?'+(+new Date())), win, fail, options);
}
function parseRta(rta){
	//detectamos renglon que contenga solo nros y espacios
	var i=0,l=rta.length;
	for(;i<l;i++){
		if(/^(?=.*\d)[\d ]+$/.test(rta[i]) && rta[i].length>10){
			ns.nro_tarjeta=rta[i];
			break;
		}
	}
	i++;
	for(;i<l;i++){
		
		if(rta[i].length>10 ){
			ns.nombre_usuario= rta[i];
			break;
		}
	}
	i++;
	for(;i<l;i++){
		if(rta[i].length>10 ){
			ns.codigo= rta[i];
			break;
		}
	}
	i++;
	for(;i<l;i++){
		if(rta[i].length>10 ){
			ns.profesion= rta[i];
			break;
		}
	}
	if(!ns.nombre_usuario && !ns.codigo && !ns.profesion && !ns.nro_tarjeta){
		getPage('home.html');
		alert('Por favor escanee la tarjeta nuevamente');
		return;
	}
	if(!ns.nombre_usuario){
		ns.nombre_usuario='';
	}
	if(!ns.codigo){
		ns.codigo='';
	}
	if(!ns.profesion){
		ns.profesion='';
	}
	if(!ns.nro_tarjeta){
		ns.nro_tarjeta='';
	}
	getPage('perfil.html',completarForm);
}
function completarForm(){
	_('nombre_usuario').value=ns.nombre_usuario;
	_('codigo').value=ns.codigo;
	_('profesion').value=ns.profesion;
	_('nro_tarjeta').value=ns.nro_tarjeta;
}
 </script>
</head>

<body>
<div id="appcontainer">
	<div class="headerhome"></div>
	<div class="container">
        <div class="row">
            <div class="col-sm-1"></div>
            <div class="col-sm-10 login2">
                <img class="img-responsive" src="images/bienvenidos.png" alt="Bienvenido">
                 <div  class="botonescanear font-opensans" onClick="capturePhotoWithFile();">ESCANEAR</div>
            </div>
            <div class="col-sm-1"></div>
    	</div>
    </div>
    <div class="piehome"></div>
</div>
</body>
</html>